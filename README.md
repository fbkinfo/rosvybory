# РосВыборы

Проект логически состоит из двух основных частей:

- Форма для создания заявок наблюдателей:

 - Сама форма, на DSL Formtastic'a, валидация через модель заявки.

 - Результат заполнения формы - заявка, `UserApp`.


- Админка, позволяющая просматривать созданные заявки, искать среди них нужные с помощью фильтров, создавать на их основе записи о людях, и т.п, по ТЗ.
 - Реализация админки - на основе [Active Admin](https://github.com/gregbell/active_admin/tree/rails4)

### Resque

Отправляет письма и смс, запускается скриптом, который был сгенерирован с помощью foreman

    sudo /etc/init.d/rosvybory start

stop у этого сервиса сейчас работает некорректно, не убивает воркера.

Для завершения всех воркеров
    
    sudo kill -9  `ps aux | grep [r]esque | grep -v grep | cut -c 10-16`

Для запуска воркера без сервиса:

    RAILS_ENV=production QUEUE='*' rake environment resque:work    

### Unicorn

    sudo /etc/init.d/unicorn_init start rosvybory_production


### Важно при первом деплое

Нужно не забыть обратить внимание на пользователя админки!

В новой БД, развёрнутой через load и seed, такого пользователя не будет, его проще всего будет создать через консоль рельсов,

`User.create!(:phone => '1234567890', :email => 'admin@example.com', :password => 'password', :password_confirmation => 'password')`, с другими данными, разумеется.

В продакшене хорошо бы ещё как-то озаботиться безопасностью в плане доступа к админке, т.к. в таком варианте, как я понимаю, вполне возможен брутфорс. Может быть пока имеет смысл дополнительно установить http-аутентификацию на location админки на уровне веб-сервера.


### Некоторые пояснения, если кто-то возьмётся дорабатывать

Модель заявок, `UserApp`:

Сейчас хранение статусов волотнёра (бывшие статусы `previous_statuses`, и те, на которые он согласен в будущем `desired_statuses`) сделано через битовые маски, в БД хранится один integer для каждого набора статусов (всего получается, соответственно, 3), в котором битовым ИЛИ собраны все отмеченные пользователем статусы. В модели динамически генерируются методы определения значения для каждого значения статуса, например, для статуса `STATUS_OBSERVER => "observer"` - методы `can_be_observer`, `was_observer`, вместе с сеттерами, методы используются для формы и для подробного вывода данных в доп. полях csv.

Заявки, по идее, после создания не должны редактироваться (кроме служебных полей) или удаляться, поэтому у контроллера отключены соответствующие действия. В админке в дальнейшем также будет отключено удаление и полное редактирование, нужно будет реализовать и дать там доступ к более специализированным действиям, таких как изменение статуса заявки или привязка к человеку.

Кроме полей, заполняемых пользователями, при создании также в заявку сохраняются ip и user agent заявителя, для дальнейшего отлова ботов или ручных накруток.

Админка:

Доступна по пути `/control`

